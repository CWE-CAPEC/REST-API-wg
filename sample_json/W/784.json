{"ID":"784","Name":"Reliance on Cookies without Validation and Integrity Checking in a Security Decision","Abstraction":"Variant","Structure":"Simple","Status":"Draft","Description":"The product uses a protection mechanism that relies on the existence or values of a cookie, but it does not properly ensure that the cookie is valid for the associated user.","ExtendedDescription":"Attackers can easily modify cookies, within the browser or by implementing the client-side code outside of the browser. Attackers can bypass protection mechanisms such as authorization and authentication by modifying the cookie to contain an expected value.","LikelihoodOfExploit":"High","RelatedWeaknesses":[{"Nature":"ChildOf","CweID":"807","ViewID":"1000"},{"Nature":"ChildOf","CweID":"565","ViewID":"1000","Ordinal":"Primary"}],"ApplicablePlatforms":[{"Type":"Language","Class":"Not Language-Specific","Prevalence":"Undetermined"},{"Type":"Technology","Class":"Web Based","Prevalence":"Often"}],"ModesOfIntroduction":[{"Phase":"Implementation"}],"CommonConsequences":[{"Scope":["Access Control"],"Impact":["Bypass Protection Mechanism","Gain Privileges or Assume Identity"],"Note":"It is dangerous to use cookies to set a user's privileges. The cookie can be manipulated to claim a high level of authorization, or to claim that successful authentication has occurred."}],"PotentialMitigations":[{"Phase":["Architecture and Design"],"Description":"Avoid using cookie data for a security-related decision."},{"Phase":["Implementation"],"Description":"Perform thorough input validation (i.e.: server side validation) on the cookie data if you're going to use it for a security related decision."},{"Phase":["Architecture and Design"],"Description":"Add integrity checks to detect tampering."},{"Phase":["Architecture and Design"],"Description":"Protect critical cookies from replay attacks, since cross-site scripting or other attacks may allow attackers to steal a strongly-encrypted cookie that also passes integrity checks. This mitigation applies to cookies that should only be valid during a single transaction or session. By enforcing timeouts, you may limit the scope of an attack. As part of your integrity check, use an unpredictable, server-side value that is not exposed to the client."}],"DemonstrativeExamples":[{"ID":"DX-15","Entries":[{"IntroText":"The following code excerpt reads a value from a browser cookie to determine the role of the user."},{"Nature":"Bad","Language":"Java","ExampleCode":"```\n\tCookie[] cookies = request.getCookies();\n\tfor (int i =0; i\u003c cookies.length; i++) {\n\t\tCookie c = cookies[i];\n\t\tif (c.getName().equals(\"role\")) {\n\t\t\tuserRole = c.getValue();\n\t\t}\n\t}\n```"}]},{"ID":"DX-16","Entries":[{"IntroText":"The following code could be for a medical records application. It performs authentication by checking if a cookie has been set."},{"Nature":"Bad","Language":"PHP","ExampleCode":"```\n\t$auth = $_COOKIES['authenticated'];\n\tif (! $auth) {\n\t\tif (AuthenticateUser($_POST['user'], $_POST['password']) == \"success\") {\n\t\t\t// save the cookie to send out in future responses\n\t\t\tsetcookie(\"authenticated\", \"1\", time()+60*60*2);\n\t\t}\n\t\telse {\n\t\t\tShowLoginScreen();\n\t\t\tdie(\"\\n\");\n\t\t}\n\t}\n\tDisplayMedicalHistory($_POST['patient_ID']);\n```"},{"BodyText":"The programmer expects that the AuthenticateUser() check will always be applied, and the \"authenticated\" cookie will only be set when authentication succeeds. The programmer even diligently specifies a 2-hour expiration for the cookie."},{"BodyText":"However, the attacker can set the \"authenticated\" cookie to a non-zero value such as 1. As a result, the $auth variable is 1, and the AuthenticateUser() check is not even performed. The attacker has bypassed the authentication."}]},{"ID":"DX-17","Entries":[{"IntroText":"In the following example, an authentication flag is read from a browser cookie, thus allowing for external control of user state data."},{"Nature":"Bad","Language":"Java","ExampleCode":"```\n\tCookie[] cookies = request.getCookies();\n\tfor (int i =0; i\u003c cookies.length; i++) {\n\t\tCookie c = cookies[i];\n\t\tif (c.getName().equals(\"authenticated\") \u0026\u0026 Boolean.TRUE.equals(c.getValue())) {\n\t\t\tauthenticated = true;\n\t\t}\n\t}\n```"}]}],"ObservedExamples":[{"Reference":"CVE-2009-1549","Description":"Attacker can bypass authentication by setting a cookie to a specific value.","Link":"https://www.cve.org/CVERecord?id=CVE-2009-1549"},{"Reference":"CVE-2009-1619","Description":"Attacker can bypass authentication and gain admin privileges by setting an \"admin\" cookie to 1.","Link":"https://www.cve.org/CVERecord?id=CVE-2009-1619"},{"Reference":"CVE-2009-0864","Description":"Content management system allows admin privileges by setting a \"login\" cookie to \"OK.\"","Link":"https://www.cve.org/CVERecord?id=CVE-2009-0864"},{"Reference":"CVE-2008-5784","Description":"e-dating application allows admin privileges by setting the admin cookie to 1.","Link":"https://www.cve.org/CVERecord?id=CVE-2008-5784"},{"Reference":"CVE-2008-6291","Description":"Web-based email list manager allows attackers to gain admin privileges by setting a login cookie to \"admin.\"","Link":"https://www.cve.org/CVERecord?id=CVE-2008-6291"}],"MappingNotes":{"Usage":"Allowed","Rationale":"This CWE entry is at the Variant level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.","Comments":"Carefully read both the name and description to ensure that this mapping is an appropriate fit. Do not try to 'force' a mapping to a lower-level Base/Variant simply to comply with this preferred level of abstraction.","Reasons":["Acceptable-Use"]},"References":[{"ExternalReferenceID":"REF-706","Authors":["Steve Christey"],"Title":"Unforgivable Vulnerabilities","PublicationYear":"2007","PublicationMonth":"08","PublicationDay":"02","URL":"http://cve.mitre.org/docs/docs-2007/unforgivable.pdf"},{"ExternalReferenceID":"REF-7","Section":"Chapter 13, \"Sensitive Data in Cookies and Fields\" Page 435","Authors":["Michael Howard","David LeBlanc"],"Title":"Writing Secure Code","Edition":"2nd Edition","PublicationYear":"2002","PublicationMonth":"12","PublicationDay":"04","Publisher":"Microsoft Press","URL":"https://www.microsoftpressstore.com/store/writing-secure-code-9780735617223"}],"Notes":[{"Type":"Maintenance","Note":"A new parent might need to be defined for this entry. This entry is specific to cookies, which reflects the significant number of vulnerabilities being reported for cookie-based authentication in CVE during 2008 and 2009. However, other types of inputs - such as parameters or headers - could also be used for similar authentication or authorization. Similar issues (under the Research view) include CWE-247 and CWE-472."}],"ContentHistory":[{"Type":"Submission","SubmissionName":"CWE Content Team","SubmissionOrganization":"MITRE","SubmissionDate":"2009-07-16"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2009-10-29","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2010-02-16","ModificationComment":"updated Demonstrative_Examples, References, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2011-06-01","ModificationComment":"updated Common_Consequences"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2017-01-19","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2017-11-08","ModificationComment":"updated Modes_of_Introduction, References, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2018-03-27","ModificationComment":"updated References"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2020-02-24","ModificationComment":"updated Applicable_Platforms, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2021-10-28","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-01-31","ModificationComment":"updated Description"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-04-27","ModificationComment":"updated Modes_of_Introduction, Relationships, Time_of_Introduction"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-06-29","ModificationComment":"updated Mapping_Notes"}]}