{"ID":"77","Name":"Improper Neutralization of Special Elements used in a Command ('Command Injection')","Abstraction":"Class","Structure":"Simple","Status":"Draft","Description":"The product constructs all or part of a command using externally-influenced input from an upstream component, but it does not neutralize or incorrectly neutralizes special elements that could modify the intended command when it is sent to a downstream component.","ExtendedDescription":"\n\nCommand injection vulnerabilities typically occur when:\n\n```\n\t\t1. Data enters the application from an untrusted source.\n\t\t2. The data is part of a string that is executed as a command by the application.\n\t\t3. By executing the command, the application gives an attacker a privilege or capability that the attacker would not otherwise have.\n```\nMany protocols and products have their own custom command language. While OS or shell command strings are frequently discovered and targeted, developers may not realize that these other command languages might also be vulnerable to attacks.\n\nCommand injection is a common problem with wrapper programs.\n","LikelihoodOfExploit":"High","RelatedWeaknesses":[{"Nature":"ChildOf","CweID":"74","ViewID":"1000","Ordinal":"Primary"},{"Nature":"ChildOf","CweID":"74","ViewID":"1003","Ordinal":"Primary"}],"WeaknessOrdinalities":[{"Ordinality":"Primary"}],"ApplicablePlatforms":[{"Type":"Language","Class":"Not Language-Specific","Prevalence":"Undetermined"}],"ModesOfIntroduction":[{"Phase":"Implementation","Note":"REALIZATION: This weakness is caused during implementation of an architectural security tactic."}],"CommonConsequences":[{"Scope":["Integrity","Confidentiality","Availability"],"Impact":["Execute Unauthorized Code or Commands"],"Note":"If a malicious user injects a character (such as a semi-colon) that delimits the end of one command and the beginning of another, it may be possible to then insert an entirely new and unrelated command that was not intended to be executed."}],"DetectionMethods":[{"DetectionMethodID":"DM-14","Method":"Automated Static Analysis","Description":"Automated static analysis, commonly referred to as Static Application Security Testing (SAST), can find some instances of this weakness by analyzing source code (or binary/compiled code) without having to execute it. Typically, this is done by building a model of data flow and control flow, then searching for potentially-vulnerable patterns that connect \"sources\" (origins of input) with \"sinks\" (destinations where the data interacts with external components, a lower layer such as the OS, etc.)","Effectiveness":"High"}],"PotentialMitigations":[{"Phase":["Architecture and Design"],"Description":"If at all possible, use library calls rather than external processes to recreate the desired functionality."},{"Phase":["Implementation"],"Description":"If possible, ensure that all external commands called from the program are statically created."},{"MitigationID":"MIT-5","Phase":["Implementation"],"Strategy":"Input Validation","Description":"\n\nAssume all input is malicious. Use an \"accept known good\" input validation strategy, i.e., use a list of acceptable inputs that strictly conform to specifications. Reject any input that does not strictly conform to specifications, or transform it into something that does.\n\n\nWhen performing input validation, consider all potentially relevant properties, including length, type of input, the full range of acceptable values, missing or extra inputs, syntax, consistency across related fields, and conformance to business rules. As an example of business rule logic, \"boat\" may be syntactically valid because it only contains alphanumeric characters, but it is not valid if the input is only expected to contain colors such as \"red\" or \"blue.\"\n\n\nDo not rely exclusively on looking for malicious or malformed inputs. This is likely to miss at least one undesirable input, especially if the code's environment changes. This can give attackers enough room to bypass the intended validation. However, denylists can be useful for detecting potential attacks or determining which inputs are so malformed that they should be rejected outright.\n"},{"Phase":["Operation"],"Description":"Run time: Run time policy enforcement may be used in an allowlist fashion to prevent use of any non-sanctioned commands."},{"Phase":["System Configuration"],"Description":"Assign permissions that prevent the user from accessing/opening privileged files."}],"DemonstrativeExamples":[{"ID":"DX-30","Entries":[{"IntroText":"The following simple program accepts a filename as a command line argument and displays the contents of the file back to the user. The program is installed setuid root because it is intended for use as a learning tool to allow system administrators in-training to inspect privileged system files without giving them the ability to modify them or damage the system."},{"Nature":"Bad","Language":"C","ExampleCode":"```\n\tint main(int argc, char** argv) {\n\t\tchar cmd[CMD_MAX] = \"/usr/bin/cat \";\n\t\tstrcat(cmd, argv[1]);\n\t\tsystem(cmd);\n\t}\n```"},{"BodyText":"Because the program runs with root privileges, the call to system() also executes with root privileges. If a user specifies a standard filename, the call works as expected. However, if an attacker passes a string of the form \";rm -rf /\", then the call to system() fails to execute cat due to a lack of arguments and then plows on to recursively delete the contents of the root partition."},{"BodyText":"Note that if argv[1] is a very long argument, then this issue might also be subject to a buffer overflow (CWE-120)."}]},{"ID":"DX-28","Entries":[{"IntroText":"The following code is from an administrative web application designed to allow users to kick off a backup of an Oracle database using a batch-file wrapper around the rman utility and then run a cleanup.bat script to delete some temporary files. The script rmanDB.bat accepts a single command line parameter, which specifies what type of backup to perform. Because access to the database is restricted, the application runs the backup as a privileged user."},{"Nature":"Bad","Language":"Java","ExampleCode":"```\n\t...\n\tString btype = request.getParameter(\"backuptype\");\n\tString cmd = new String(\"cmd.exe /K \\\"\n\t\tc:\\\\util\\\\rmanDB.bat \"\n\t\t+btype+\n\t\t\"\u0026\u0026c:\\\\utl\\\\cleanup.bat\\\"\")\n\tSystem.Runtime.getRuntime().exec(cmd);\n\t...\n```"},{"BodyText":"The problem here is that the program does not do any validation on the backuptype parameter read from the user. Typically the Runtime.exec() function will not execute multiple commands, but in this case the program first runs the cmd.exe shell in order to run multiple commands with a single call to Runtime.exec(). Once the shell is invoked, it will happily execute multiple commands separated by two ampersands. If an attacker passes a string of the form \"\u0026 del c:\\\\dbms\\\\*.*\", then the application will execute this command along with the others specified by the program. Because of the nature of the application, it runs with the privileges necessary to interact with the database, which means whatever command the attacker injects will run with those privileges as well."}]},{"Entries":[{"IntroText":"The following code from a system utility uses the system property APPHOME to determine the directory in which it is installed and then executes an initialization script based on a relative path from the specified directory."},{"Nature":"Bad","Language":"Java","ExampleCode":"```\n\t...\n\tString home = System.getProperty(\"APPHOME\");\n\tString cmd = home + INITCMD;\n\tjava.lang.Runtime.getRuntime().exec(cmd);\n\t...\n```"},{"BodyText":"The code above allows an attacker to execute arbitrary commands with the elevated privilege of the application by modifying the system property APPHOME to point to a different path containing a malicious version of INITCMD. Because the program does not validate the value read from the environment, if an attacker can control the value of the system property APPHOME, then they can fool the application into running malicious code and take control of the system."}]},{"Entries":[{"IntroText":"The following code is a wrapper around the UNIX command cat which prints the contents of a file to standard out. It is also injectable:"},{"Nature":"Bad","Language":"C","ExampleCode":"```\n\t#include \u003cstdio.h\u003e\n\t#include \u003cunistd.h\u003e\n\tint main(int argc, char **argv) {\n\t\t\tchar cat[] = \"cat \";\n\t\t\tchar *command;\n\t\t\tsize_t commandLength;\n\t\t\tcommandLength = strlen(cat) + strlen(argv[1]) + 1;\n\t\t\tcommand = (char *) malloc(commandLength);\n\t\t\tstrncpy(command, cat, commandLength);\n\t\t\tstrncat(command, argv[1], (commandLength - strlen(cat)) );\n\t\t\tsystem(command);\n\t\t\treturn (0);\n\t}\n```"},{"BodyText":"Used normally, the output is simply the contents of the file requested:"},{"Nature":"Informative","ExampleCode":"```\n\t$ ./catWrapper Story.txt\n\tWhen last we left our heroes...\n```"},{"BodyText":"However, if we add a semicolon and another command to the end of this line, the command is executed by catWrapper with no complaint:"},{"Nature":"Attack","ExampleCode":"```\n\t$ ./catWrapper Story.txt; ls\n\tWhen last we left our heroes...\n\tStory.txt\n\tSensitiveFile.txt\n\tPrivateData.db\n\ta.out*\n```"},{"BodyText":"If catWrapper had been set to have a higher privilege level than the standard user, arbitrary commands could be executed with that higher privilege."}]}],"ObservedExamples":[{"Reference":"CVE-2022-36069","Description":"Python-based dependency management tool avoids OS command injection when generating Git commands but allows injection of optional arguments with input beginning with a dash, potentially allowing for code execution.","Link":"https://www.cve.org/CVERecord?id=CVE-2022-36069"},{"Reference":"CVE-1999-0067","Description":"Canonical example of OS command injection. CGI program does not neutralize \"|\" metacharacter when invoking a phonebook program.","Link":"https://www.cve.org/CVERecord?id=CVE-1999-0067"},{"Reference":"CVE-2020-9054","Description":"Chain: improper input validation (CWE-20) in username parameter, leading to OS command injection (CWE-78), as exploited in the wild per CISA KEV.","Link":"https://www.cve.org/CVERecord?id=CVE-2020-9054"},{"Reference":"CVE-2022-1509","Description":"injection of sed script syntax (\"sed injection\")","Link":"https://www.cve.org/CVERecord?id=CVE-2022-1509"},{"Reference":"CVE-2021-41282","Description":"injection of sed script syntax (\"sed injection\")","Link":"https://www.cve.org/CVERecord?id=CVE-2021-41282"},{"Reference":"CVE-2019-13398","Description":"injection of sed script syntax (\"sed injection\")","Link":"https://www.cve.org/CVERecord?id=CVE-2019-13398"},{"Reference":"CVE-2019-12921","Description":"image program allows injection of commands in \"Magick Vector Graphics (MVG)\" language.","Link":"https://www.cve.org/CVERecord?id=CVE-2019-12921"},{"Reference":"CVE-2020-11698","Description":"anti-spam product allows injection of SNMP commands into confiuration file","Link":"https://www.cve.org/CVERecord?id=CVE-2020-11698"}],"TaxonomyMappings":[{"TaxonomyName":"7 Pernicious Kingdoms","EntryName":"Command Injection"},{"TaxonomyName":"CLASP","EntryName":"Command injection"},{"TaxonomyName":"OWASP Top Ten 2007","EntryID":"A2","EntryName":"Injection Flaws","MappingFit":"CWE More Specific"},{"TaxonomyName":"OWASP Top Ten 2004","EntryID":"A1","EntryName":"Unvalidated Input","MappingFit":"CWE More Specific"},{"TaxonomyName":"OWASP Top Ten 2004","EntryID":"A6","EntryName":"Injection Flaws","MappingFit":"CWE More Specific"},{"TaxonomyName":"Software Fault Patterns","EntryID":"SFP24","EntryName":"Tainted input to command"},{"TaxonomyName":"SEI CERT Perl Coding Standard","EntryID":"IDS34-PL","EntryName":"Do not pass untrusted, unsanitized data to a command interpreter","MappingFit":"CWE More Specific"}],"RelatedAttackPatterns":["136","15","183","248","40","43","75","76"],"MappingNotes":{"Usage":"Allowed-with-Review","Rationale":"CWE-77 is often misused when OS command injection (CWE-78) was intended instead [REF-1287].","Comments":"If the weakness involves a command language besides OS shell invocation, then CWE-77 could be used.","Reasons":["Frequent Misuse"]},"References":[{"ExternalReferenceID":"REF-6","Authors":["Katrina Tsipenyuk","Brian Chess","Gary McGraw"],"Title":"Seven Pernicious Kingdoms: A Taxonomy of Software Security Errors","Publication":"NIST Workshop on Software Security Assurance Tools Techniques and Metrics","PublicationYear":"2005","PublicationMonth":"11","PublicationDay":"07","Publisher":"NIST","URL":"https://samate.nist.gov/SSATTM_Content/papers/Seven%20Pernicious%20Kingdoms%20-%20Taxonomy%20of%20Sw%20Security%20Errors%20-%20Tsipenyuk%20-%20Chess%20-%20McGraw.pdf"},{"ExternalReferenceID":"REF-140","Authors":["Greg Hoglund","Gary McGraw"],"Title":"Exploiting Software: How to Break Code","PublicationYear":"2004","PublicationMonth":"02","PublicationDay":"27","Publisher":"Addison-Wesley","URL":"https://www.amazon.com/Exploiting-Software-How-Break-Code/dp/0201786958","URLDate":"2023-04-07"},{"ExternalReferenceID":"REF-44","Section":"\"Sin 10: Command Injection.\" Page 171","Authors":["Michael Howard","David LeBlanc","John Viega"],"Title":"24 Deadly Sins of Software Security","Publication":"McGraw-Hill","PublicationYear":"2010"},{"ExternalReferenceID":"REF-1287","Section":"Details of Problematic Mappings","Authors":["MITRE"],"Title":"Supplemental Details - 2022 CWE Top 25","PublicationYear":"2022","PublicationMonth":"06","PublicationDay":"28","URL":"https://cwe.mitre.org/top25/archive/2022/2022_cwe_top25_supplemental.html#problematicMappingDetails"}],"Notes":[{"Type":"Terminology","Note":"\n\nThe \"command injection\" phrase carries different meanings to different people. For some people, it refers to any type of attack that can allow the attacker to execute commands of their own choosing, regardless of how those commands are inserted. The command injection could thus be resultant from another weakness. This usage also includes cases in which the functionality allows the user to specify an entire command, which is then executed; within CWE, this situation might be better regarded as an authorization problem (since an attacker should not be able to specify arbitrary commands.)\n\n\nAnother common usage, which includes CWE-77 and its descendants, involves cases in which the attacker injects separators into the command being constructed.\n"}],"ContentHistory":[{"Type":"Submission","SubmissionName":"7 Pernicious Kingdoms","SubmissionDate":"2006-07-19"},{"Type":"Modification","ModificationName":"Eric Dalci","ModificationOrganization":"Cigital","ModificationDate":"2008-07-01","ModificationComment":"updated Time_of_Introduction"},{"Type":"Modification","ModificationOrganization":"Veracode","ModificationDate":"2008-08-15","ModificationComment":"Suggested OWASP Top Ten 2004 mapping"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2008-09-08","ModificationComment":"updated Common_Consequences, Relationships, Other_Notes, Taxonomy_Mappings, Weakness_Ordinalities"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2009-05-27","ModificationComment":"updated Demonstrative_Examples, Name"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2009-07-27","ModificationComment":"updated Demonstrative_Examples, Description, Name"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2009-10-29","ModificationComment":"updated Common_Consequences, Description, Other_Notes, Potential_Mitigations"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2010-02-16","ModificationComment":"updated Potential_Mitigations, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2010-06-21","ModificationComment":"updated Description, Name"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2011-03-29","ModificationComment":"updated Demonstrative_Examples"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2011-06-01","ModificationComment":"updated Common_Consequences"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2012-05-11","ModificationComment":"updated Common_Consequences, Demonstrative_Examples, References, Related_Attack_Patterns, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2012-10-30","ModificationComment":"updated Potential_Mitigations"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2013-02-21","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2013-07-17","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2014-02-18","ModificationComment":"updated Applicable_Platforms, Demonstrative_Examples, Description, Other_Notes, Terminology_Notes"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2014-06-23","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2014-07-30","ModificationComment":"updated Relationships, Taxonomy_Mappings"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2015-12-07","ModificationComment":"updated Demonstrative_Examples, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2017-05-03","ModificationComment":"updated Potential_Mitigations, Related_Attack_Patterns, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2017-11-08","ModificationComment":"updated Causal_Nature, Likelihood_of_Exploit, Modes_of_Introduction, References, Relationships, Taxonomy_Mappings"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2018-03-27","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2019-01-03","ModificationComment":"updated Taxonomy_Mappings"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2019-06-20","ModificationComment":"updated Related_Attack_Patterns, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2020-02-24","ModificationComment":"updated Potential_Mitigations, References, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2020-06-25","ModificationComment":"updated Potential_Mitigations"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2020-08-20","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2020-12-10","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2021-03-15","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2021-07-20","ModificationComment":"updated Description, Observed_Examples, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2021-10-28","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2022-06-28","ModificationComment":"updated Observed_Examples, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2022-10-13","ModificationComment":"updated Observed_Examples, References, Terminology_Notes"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-01-31","ModificationComment":"updated Description, Potential_Mitigations"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-04-27","ModificationComment":"updated Detection_Factors, Relationships, Time_of_Introduction"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-06-29","ModificationComment":"updated Mapping_Notes, Relationships"},{"Type":"Contribution","ContributionName":"Anonymous External Contributor","ContributionDate":"2022-05-20","ContributionComment":"reported typo in Terminology note","ContributionType":"Feedback"},{"Type":"Rename","PreviousEntryName":"Command Injection","Date":"2008-04-11"},{"Type":"Rename","PreviousEntryName":"Failure to Sanitize Data into a Control Plane (aka 'Command Injection')","Date":"2009-05-27"},{"Type":"Rename","PreviousEntryName":"Failure to Sanitize Data into a Control Plane ('Command Injection')","Date":"2009-07-27"},{"Type":"Rename","PreviousEntryName":"Improper Sanitization of Special Elements used in a Command ('Command Injection')","Date":"2010-06-21"}]}