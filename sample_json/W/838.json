{"ID":"838","Name":"Inappropriate Encoding for Output Context","Abstraction":"Base","Structure":"Simple","Status":"Incomplete","Description":"The product uses or specifies an encoding when generating output to a downstream component, but the specified encoding is not the same as the encoding that is expected by the downstream component.","ExtendedDescription":"\n\nThis weakness can cause the downstream component to use a decoding method that produces different data than what the product intended to send. When the wrong encoding is used - even if closely related - the downstream component could decode the data incorrectly. This can have security consequences when the provided boundaries between control and data are inadvertently broken, because the resulting data could introduce control characters or special elements that were not sent by the product. The resulting data could then be used to bypass protection mechanisms such as input validation, and enable injection attacks.\n\n\nWhile using output encoding is essential for ensuring that communications between components are accurate, the use of the wrong encoding - even if closely related - could cause the downstream component to misinterpret the output.\n\n\nFor example, HTML entity encoding is used for elements in the HTML body of a web page. However, a programmer might use entity encoding when generating output for that is used within an attribute of an HTML tag, which could contain functional Javascript that is not affected by the HTML encoding.\n\n\nWhile web applications have received the most attention for this problem, this weakness could potentially apply to any type of product that uses a communications stream that could support multiple encodings.\n","RelatedWeaknesses":[{"Nature":"ChildOf","CweID":"116","ViewID":"1000","Ordinal":"Primary"},{"Nature":"ChildOf","CweID":"116","ViewID":"1003","Ordinal":"Primary"}],"ApplicablePlatforms":[{"Type":"Language","Class":"Not Language-Specific","Prevalence":"Undetermined"}],"CommonConsequences":[{"Scope":["Integrity","Confidentiality","Availability"],"Impact":["Modify Application Data","Execute Unauthorized Code or Commands"],"Note":"An attacker could modify the structure of the message or data being sent to the downstream component, possibly injecting commands."}],"DetectionMethods":[{"DetectionMethodID":"DM-14","Method":"Automated Static Analysis","Description":"Automated static analysis, commonly referred to as Static Application Security Testing (SAST), can find some instances of this weakness by analyzing source code (or binary/compiled code) without having to execute it. Typically, this is done by building a model of data flow and control flow, then searching for potentially-vulnerable patterns that connect \"sources\" (origins of input) with \"sinks\" (destinations where the data interacts with external components, a lower layer such as the OS, etc.)","Effectiveness":"High"}],"PotentialMitigations":[{"Phase":["Implementation"],"Strategy":"Output Encoding","Description":"Use context-aware encoding. That is, understand which encoding is being used by the downstream component, and ensure that this encoding is used. If an encoding can be specified, do so, instead of assuming that the default encoding is the same as the default being assumed by the downstream component."},{"Phase":["Architecture and Design"],"Strategy":"Output Encoding","Description":"Where possible, use communications protocols or data formats that provide strict boundaries between control and data. If this is not feasible, ensure that the protocols or formats allow the communicating components to explicitly state which encoding/decoding method is being used. Some template frameworks provide built-in support."},{"MitigationID":"MIT-4.3","Phase":["Architecture and Design"],"Strategy":"Libraries or Frameworks","Description":"\n\nUse a vetted library or framework that does not allow this weakness to occur or provides constructs that make this weakness easier to avoid.\n\n\nFor example, consider using the ESAPI Encoding control [REF-45] or a similar tool, library, or framework. These will help the programmer encode outputs in a manner less prone to error.\n\n\nNote that some template mechanisms provide built-in support for the appropriate encoding.\n"}],"DemonstrativeExamples":[{"Entries":[{"IntroText":"This code dynamically builds an HTML page using POST data:"},{"Nature":"Bad","Language":"PHP","ExampleCode":"```\n\t$username = $_POST['username'];\n\t$picSource = $_POST['picsource'];\n\t$picAltText = $_POST['picalttext'];\n```\n...* \n\t\n\techo \"\u003ctitle\u003eWelcome, \" . htmlentities($username) .\"\u003c/title\u003e\";\n\techo \"\u003cimg src='\". htmlentities($picSource) .\" ' alt='\". htmlentities($picAltText) . '\" /\u003e';\n\t\n\t *...*"},{"BodyText":"The programmer attempts to avoid XSS exploits (CWE-79) by encoding the POST values so they will not be interpreted as valid HTML. However, the htmlentities() encoding is not appropriate when the data are used as HTML attributes, allowing more attributes to be injected."},{"BodyText":"For example, an attacker can set picAltText to:"},{"Nature":"Attack","ExampleCode":"```\n\t\"altTextHere' onload='alert(document.cookie)\"\n```"},{"BodyText":"This will result in the generated HTML image tag:"},{"Nature":"Result","Language":"HTML","ExampleCode":"```\n\t\u003cimg src='pic.jpg' alt='altTextHere' onload='alert(document.cookie)' /\u003e\n```"},{"BodyText":"The attacker can inject arbitrary javascript into the tag due to this incorrect encoding."}]}],"ObservedExamples":[{"Reference":"CVE-2009-2814","Description":"Server does not properly handle requests that do not contain UTF-8 data; browser assumes UTF-8, allowing XSS.","Link":"https://www.cve.org/CVERecord?id=CVE-2009-2814"}],"TaxonomyMappings":[{"TaxonomyName":"The CERT Oracle Secure Coding Standard for Java (2011)","EntryID":"IDS13-J","EntryName":"Use compatible encodings on both sides of file or network IO"}],"RelatedAttackPatterns":["468"],"MappingNotes":{"Usage":"Allowed","Rationale":"This CWE entry is at the Base level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.","Comments":"Carefully read both the name and description to ensure that this mapping is an appropriate fit. Do not try to 'force' a mapping to a lower-level Base/Variant simply to comply with this preferred level of abstraction.","Reasons":["Acceptable-Use"]},"References":[{"ExternalReferenceID":"REF-786","Authors":["Jim Manico"],"Title":"Injection-safe templating languages","PublicationYear":"2010","PublicationMonth":"06","PublicationDay":"30","URL":"https://manicode.blogspot.com/2010/06/injection-safe-templating-languages_30.html","URLDate":"2023-04-07"},{"ExternalReferenceID":"REF-787","Authors":["Dinis Cruz"],"Title":"Can we please stop saying that XSS is boring and easy to fix!","PublicationYear":"2010","PublicationMonth":"09","PublicationDay":"25","URL":"http://diniscruz.blogspot.com/2010/09/can-we-please-stop-saying-that-xss-is.html"},{"ExternalReferenceID":"REF-788","Authors":["Ivan Ristic"],"Title":"Canoe: XSS prevention via context-aware output encoding","PublicationYear":"2010","PublicationMonth":"09","PublicationDay":"24","URL":"https://blog.ivanristic.com/2010/09/introducing-canoe-context-aware-output-encoding-for-xss-prevention.html","URLDate":"2023-04-07"},{"ExternalReferenceID":"REF-789","Authors":["Jim Manico"],"Title":"What is the Future of Automated XSS Defense Tools?","PublicationYear":"2011","PublicationMonth":"03","PublicationDay":"08","URL":"http://software-security.sans.org/downloads/appsec-2011-files/manico-appsec-future-tools.pdf"},{"ExternalReferenceID":"REF-709","Section":"Preventing XSS Attacks","Authors":["Jeremiah Grossman","Robert \"RSnake\" Hansen","Petko \"pdp\" D. Petkov","Anton Rager","Seth Fogie"],"Title":"XSS Attacks","PublicationYear":"2007","Publisher":"Syngress"},{"ExternalReferenceID":"REF-725","Authors":["OWASP"],"Title":"DOM based XSS Prevention Cheat Sheet","URL":"http://www.owasp.org/index.php/DOM_based_XSS_Prevention_Cheat_Sheet"},{"ExternalReferenceID":"REF-45","Authors":["OWASP"],"Title":"OWASP Enterprise Security API (ESAPI) Project","URL":"http://www.owasp.org/index.php/ESAPI"}],"ContentHistory":[{"Type":"Submission","SubmissionName":"CWE Content Team","SubmissionOrganization":"MITRE","SubmissionDate":"2011-03-24"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2011-06-01","ModificationComment":"updated Common_Consequences, Relationships, Taxonomy_Mappings"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2011-06-27","ModificationComment":"updated Demonstrative_Examples, Related_Attack_Patterns, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2012-05-11","ModificationComment":"updated Potential_Mitigations, References, Relationships, Taxonomy_Mappings"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2017-11-08","ModificationComment":"updated References, Taxonomy_Mappings"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2019-01-03","ModificationComment":"updated Relationships, Taxonomy_Mappings"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2019-06-20","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2020-02-24","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-01-31","ModificationComment":"updated Description"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-04-27","ModificationComment":"updated Detection_Factors, References, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-06-29","ModificationComment":"updated Mapping_Notes"}]}