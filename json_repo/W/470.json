{"ID":"470","Name":"Use of Externally-Controlled Input to Select Classes or Code ('Unsafe Reflection')","Abstraction":"Base","Structure":"Simple","Status":"Draft","Description":"The product uses external input with reflection to select which classes or code to use, but it does not sufficiently prevent the input from selecting improper classes or code.","ExtendedDescription":"If the product uses external inputs to determine which class to instantiate or which method to invoke, then an attacker could supply values to select unexpected classes or methods. If this occurs, then the attacker could create control flow paths that were not intended by the developer. These paths could bypass authentication or access control checks, or otherwise cause the product to behave in an unexpected manner. This situation becomes a doomsday scenario if the attacker can upload files into a location that appears on the product's classpath (CWE-427) or add new entries to the product's classpath (CWE-426). Under either of these conditions, the attacker can use reflection to introduce new, malicious behavior into the product.","RelatedWeaknesses":[{"Nature":"ChildOf","CweID":"913","ViewID":"1000","Ordinal":"Primary"},{"Nature":"ChildOf","CweID":"913","ViewID":"1003","Ordinal":"Primary"},{"Nature":"ChildOf","CweID":"610","ViewID":"1000"},{"Nature":"ChildOf","CweID":"20","ViewID":"700","Ordinal":"Primary"}],"WeaknessOrdinalities":[{"Ordinality":"Primary"}],"ApplicablePlatforms":[{"Type":"Language","Name":"Java","Prevalence":"Undetermined"},{"Type":"Language","Name":"PHP","Prevalence":"Undetermined"},{"Type":"Language","Class":"Interpreted","Prevalence":"Sometimes"}],"AlternateTerms":[{"Term":"Reflection Injection"}],"ModesOfIntroduction":[{"Phase":"Architecture and Design"},{"Phase":"Implementation"}],"CommonConsequences":[{"Scope":["Integrity","Confidentiality","Availability","Other"],"Impact":["Execute Unauthorized Code or Commands","Alter Execution Logic"],"Note":"The attacker might be able to execute code that is not directly accessible to the attacker. Alternately, the attacker could call unexpected code in the wrong place or the wrong time, possibly modifying critical system state."},{"Scope":["Availability","Other"],"Impact":["DoS: Crash, Exit, or Restart","Other"],"Note":"The attacker might be able to use reflection to call the wrong code, possibly with unexpected arguments that violate the API (CWE-227). This could cause the product to exit or hang."},{"Scope":["Confidentiality"],"Impact":["Read Application Data"],"Note":"By causing the wrong code to be invoked, the attacker might be able to trigger a runtime error that leaks sensitive information in the error message, such as CWE-536."}],"DetectionMethods":[{"DetectionMethodID":"DM-14","Method":"Automated Static Analysis","Description":"Automated static analysis, commonly referred to as Static Application Security Testing (SAST), can find some instances of this weakness by analyzing source code (or binary/compiled code) without having to execute it. Typically, this is done by building a model of data flow and control flow, then searching for potentially-vulnerable patterns that connect \"sources\" (origins of input) with \"sinks\" (destinations where the data interacts with external components, a lower layer such as the OS, etc.)","Effectiveness":"High"}],"PotentialMitigations":[{"Phase":["Architecture and Design"],"Description":"Refactor your code to avoid using reflection."},{"Phase":["Architecture and Design"],"Description":"Do not use user-controlled inputs to select and load classes or code."},{"Phase":["Implementation"],"Description":"Apply strict input validation by using allowlists or indirect selection to ensure that the user is only selecting allowable classes or code."}],"DemonstrativeExamples":[{"ID":"DX-232","Entries":[{"IntroText":"A common reason that programmers use the reflection API is to implement their own command dispatcher. The following example shows a command dispatcher that does not use reflection:"},{"Nature":"Good","Language":"Java","ExampleCode":"```\n\tString ctl = request.getParameter(\"ctl\");\n\t Worker ao = null;\n\t if (ctl.equals(\"Add\")) { \n\t\t ao = new AddCommand(); \n\t }\n\t else if (ctl.equals(\"Modify\")) { \n\t\t ao = new ModifyCommand(); \n\t }\n\t else { \n\t\t throw new UnknownActionError(); \n\t} \n\t ao.doAction(request); \n```"},{"BodyText":"A programmer might refactor this code to use reflection as follows:"},{"Nature":"Bad","Language":"Java","ExampleCode":"```\n\t String ctl = request.getParameter(\"ctl\");\n\t Class cmdClass = Class.forName(ctl + \"Command\");\n\t Worker ao = (Worker) cmdClass.newInstance();\n\t ao.doAction(request); \n```"},{"BodyText":"The refactoring initially appears to offer a number of advantages. There are fewer lines of code, the if/else blocks have been entirely eliminated, and it is now possible to add new command types without modifying the command dispatcher.\n\n\nHowever, the refactoring allows an attacker to instantiate any object that implements the Worker interface. If the command dispatcher is still responsible for access control, then whenever programmers create a new class that implements the Worker interface, they must remember to modify the dispatcher's access control code. If they do not modify the access control code, then some Worker classes will not have any access control."},{"BodyText":"One way to address this access control problem is to make the Worker object responsible for performing the access control check. An example of the re-refactored code follows:"},{"Nature":"Bad","Language":"Java","ExampleCode":"```\n\t String ctl = request.getParameter(\"ctl\");\n\t Class cmdClass = Class.forName(ctl + \"Command\");\n\t Worker ao = (Worker) cmdClass.newInstance();\n\t ao.checkAccessControl(request);\n\t ao.doAction(request); \n```"},{"BodyText":"Although this is an improvement, it encourages a decentralized approach to access control, which makes it easier for programmers to make access control mistakes."},{"BodyText":"This code also highlights another security problem with using reflection to build a command dispatcher. An attacker can invoke the default constructor for any kind of object. In fact, the attacker is not even constrained to objects that implement the Worker interface; the default constructor for any object in the system can be invoked. If the object does not implement the Worker interface, a ClassCastException will be thrown before the assignment to ao, but if the constructor performs operations that work in the attacker's favor, the damage will already have been done. Although this scenario is relatively benign in simple products, in larger products where complexity grows exponentially, it is not unreasonable that an attacker could find a constructor to leverage as part of an attack."}]}],"ObservedExamples":[{"Reference":"CVE-2018-1000613","Description":"Cryptography API uses unsafe reflection when deserializing a private key","Link":"https://www.cve.org/CVERecord?id=CVE-2018-1000613"},{"Reference":"CVE-2004-2331","Description":"Database system allows attackers to bypass sandbox restrictions by using the Reflection API.","Link":"https://www.cve.org/CVERecord?id=CVE-2004-2331"}],"TaxonomyMappings":[{"TaxonomyName":"7 Pernicious Kingdoms","EntryName":"Unsafe Reflection"},{"TaxonomyName":"The CERT Oracle Secure Coding Standard for Java (2011)","EntryID":"SEC06-J","EntryName":"Do not use reflection to increase accessibility of classes, methods, or fields"}],"RelatedAttackPatterns":["138"],"References":[{"ExternalReferenceID":"REF-6","Authors":["Katrina Tsipenyuk","Brian Chess","Gary McGraw"],"Title":"Seven Pernicious Kingdoms: A Taxonomy of Software Security Errors","Publication":"NIST Workshop on Software Security Assurance Tools Techniques and Metrics","PublicationYear":"2005","PublicationMonth":"11","PublicationDay":"07","Publisher":"NIST","URL":"https://samate.nist.gov/SSATTM_Content/papers/Seven%20Pernicious%20Kingdoms%20-%20Taxonomy%20of%20Sw%20Security%20Errors%20-%20Tsipenyuk%20-%20Chess%20-%20McGraw.pdf"}],"MappingNotes":{"Usage":"Allowed","Rationale":"This CWE entry is at the Base level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.","Comments":"Carefully read both the name and description to ensure that this mapping is an appropriate fit. Do not try to 'force' a mapping to a lower-level Base/Variant simply to comply with this preferred level of abstraction.","Reasons":["Acceptable-Use"]},"ContentHistory":[{"Type":"Submission","SubmissionName":"7 Pernicious Kingdoms","SubmissionDate":"2006-07-19","SubmissionVersion":"Draft 3","SubmissionReleaseDate":"2006-07-19"},{"Type":"Modification","ModificationName":"Eric Dalci","ModificationOrganization":"Cigital","ModificationDate":"2008-07-01","ModificationComment":"updated Potential_Mitigations, Time_of_Introduction"},{"Type":"Modification","ModificationOrganization":"KDM Analytics","ModificationDate":"2008-08-01","ModificationComment":"added/updated white box definitions"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2008-09-08","ModificationComment":"updated Description, Relationships, Other_Notes, Taxonomy_Mappings"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2008-10-14","ModificationComment":"updated Applicable_Platforms, Demonstrative_Examples, Description, Other_Notes"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2009-01-12","ModificationComment":"updated Applicable_Platforms, Common_Consequences, Demonstrative_Examples, Observed_Examples, Potential_Mitigations"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2009-05-27","ModificationComment":"updated Demonstrative_Examples, Name"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2009-10-29","ModificationComment":"updated Alternate_Terms, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2011-03-29","ModificationComment":"updated Demonstrative_Examples"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2011-06-01","ModificationComment":"updated Common_Consequences, Relationships, Taxonomy_Mappings"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2012-05-11","ModificationComment":"updated Relationships, Taxonomy_Mappings"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2013-02-21","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2014-07-30","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2017-11-08","ModificationComment":"updated White_Box_Definitions"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2019-01-03","ModificationComment":"updated Taxonomy_Mappings"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2019-06-20","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2020-02-24","ModificationComment":"updated References, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2020-06-25","ModificationComment":"updated Potential_Mitigations"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2021-10-28","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-01-31","ModificationComment":"updated Common_Consequences, Demonstrative_Examples, Description, Related_Attack_Patterns, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-04-27","ModificationComment":"updated Detection_Factors, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-06-29","ModificationComment":"updated Mapping_Notes"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-10-26","ModificationComment":"updated Observed_Examples"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2025-12-11","ModificationComment":"updated Demonstrative_Examples, Relationships, Weakness_Ordinalities","ModificationVersion":"4.19","ModificationReleaseDate":"2025-12-11"},{"Type":"Rename","PreviousEntryName":"Unsafe Reflection","Date":"2008-04-11"},{"Type":"Rename","PreviousEntryName":"Use of Externally-Controlled Input to Select Classes or Code (aka 'Unsafe Reflection')","Date":"2009-05-27"}]}