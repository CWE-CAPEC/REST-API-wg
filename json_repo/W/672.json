{"ID":"672","Name":"Operation on a Resource after Expiration or Release","Abstraction":"Class","Structure":"Simple","Status":"Draft","Description":"The product uses, accesses, or otherwise operates on a resource after that resource has been expired, released, or revoked.","RelatedWeaknesses":[{"Nature":"ChildOf","CweID":"666","ViewID":"1000","Ordinal":"Primary"}],"ApplicablePlatforms":[{"Type":"Language","Class":"Not Language-Specific","Prevalence":"Undetermined"},{"Type":"Technology","Class":"Mobile","Prevalence":"Undetermined"}],"ModesOfIntroduction":[{"Phase":"Implementation"},{"Phase":"Operation"}],"CommonConsequences":[{"Scope":["Integrity","Confidentiality"],"Impact":["Modify Application Data","Read Application Data"],"Note":"If a released resource is subsequently reused or reallocated, then an attempt to use the original resource might allow access to sensitive data that is associated with a different user or entity."},{"Scope":["Other","Availability"],"Impact":["Other","DoS: Crash, Exit, or Restart"],"Note":"When a resource is released it might not be in an expected state, later attempts to access the resource may lead to resultant errors that may lead to a crash."}],"DemonstrativeExamples":[{"ID":"DX-71","Entries":[{"IntroText":"The following code shows a simple example of a use after free error:"},{"Nature":"Bad","Language":"C","ExampleCode":"```\n\tchar* ptr = (char*)malloc (SIZE);\n\tif (err) {\n\t\tabrt = 1;\n\t\tfree(ptr);\n\t}\n\t...\n\tif (abrt) {\n\t\tlogError(\"operation aborted before commit\", ptr);\n\t}\n```"},{"BodyText":"When an error occurs, the pointer is immediately freed. However, this pointer is later incorrectly used in the logError function."}]},{"ID":"DX-72","Entries":[{"IntroText":"The following code shows a simple example of a double free error:"},{"Nature":"Bad","Language":"C","ExampleCode":"```\n\tchar* ptr = (char*)malloc (SIZE);\n\t...\n\tif (abrt) {\n\t\tfree(ptr);\n\t}\n\t...\n\tfree(ptr);\n```"},{"BodyText":"Double free vulnerabilities have two common (and sometimes overlapping) causes:"},{"BodyText":"- Error conditions and other exceptional circumstances\n\n  - Confusion over which part of the program is responsible for freeing the memory"},{"BodyText":"Although some double free vulnerabilities are not much more complicated than the previous example, most are spread out across hundreds of lines of code or even different files. Programmers seem particularly susceptible to freeing global variables more than once."}]},{"Entries":[{"IntroText":"In the following C/C++ example the method processMessage is used to process a message received in the input array of char arrays. The input message array contains two char arrays: the first is the length of the message and the second is the body of the message. The length of the message is retrieved and used to allocate enough memory for a local char array, messageBody, to be created for the message body. The messageBody is processed in the method processMessageBody that will return an error if an error occurs while processing. If an error occurs then the return result variable is set to indicate an error and the messageBody char array memory is released using the method free and an error message is sent to the logError method."},{"Nature":"Bad","Language":"C","ExampleCode":"```\n\t#define FAIL 0\n\t#define SUCCESS 1\n\t#define ERROR -1\n\t#define MAX_MESSAGE_SIZE 32\n\tint processMessage(char **message)\n\t{\n\t\t\tint result = SUCCESS;\n\t\t\tint length = getMessageLength(message[0]);\n\t\t\tchar *messageBody;\n\t\t\tif ((length \u003e 0) \u0026\u0026 (length \u003c MAX_MESSAGE_SIZE)) {\n\t\t\t\t\tmessageBody = (char*)malloc(length*sizeof(char));\n\t\t\t\t\tmessageBody = \u0026message[1][0];\n\t\t\t\t\tint success = processMessageBody(messageBody);\n\t\t\t\t\tif (success == ERROR) {\n\t\t\t\t\t\tresult = ERROR;\n\t\t\t\t\t\tfree(messageBody);\n\t\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprintf(\"Unable to process message; invalid message length\");\n\t\t\t\tresult = FAIL;\n\t\t\t}\n\t\t\tif (result == ERROR) {\n\t\t\t\tlogError(\"Error processing message\", messageBody);\n\t\t\t}\n\t\t\treturn result;\n\t}\n```"},{"BodyText":"However, the call to the method logError includes the messageBody after the memory for messageBody has been released using the free method. This can cause unexpected results and may lead to system crashes. A variable should never be used after its memory resources have been released."},{"Nature":"Good","Language":"C","ExampleCode":"```\n\t...\n\tmessageBody = (char*)malloc(length*sizeof(char));\n\tmessageBody = \u0026message[1][0];\n\tint success = processMessageBody(messageBody);\n\tif (success == ERROR) {\n\t\tresult = ERROR;\n\t\tlogError(\"Error processing message\", messageBody);\n\t\tfree(messageBody);\n\t}\n\t...\n```"}]}],"ObservedExamples":[{"Reference":"CVE-2009-3547","Description":"Chain: race condition (CWE-362) might allow resource to be released before operating on it, leading to NULL dereference (CWE-476)","Link":"https://www.cve.org/CVERecord?id=CVE-2009-3547"}],"TaxonomyMappings":[{"TaxonomyName":"Software Fault Patterns","EntryID":"SFP15","EntryName":"Faulty Resource Use"},{"TaxonomyName":"CERT C Secure Coding","EntryID":"FIO46-C","EntryName":"Do not access a closed file","MappingFit":"CWE More Abstract"},{"TaxonomyName":"CERT C Secure Coding","EntryID":"MEM30-C","EntryName":"Do not access freed memory","MappingFit":"CWE More Abstract"},{"TaxonomyName":"OMG ASCSM","EntryID":"ASCSM-CWE-672"}],"References":[{"ExternalReferenceID":"REF-962","Section":"ASCSM-CWE-672","Authors":["Object Management Group (OMG)"],"Title":"Automated Source Code Security Measure (ASCSM)","PublicationYear":"2016","PublicationMonth":"01","URL":"http://www.omg.org/spec/ASCSM/1.0/"}],"MappingNotes":{"Usage":"Allowed-with-Review","Rationale":"This CWE entry is a Class and might have Base-level children that would be more appropriate","Comments":"Examine children of this entry to see if there is a better fit","Reasons":["Abstraction"]},"ContentHistory":[{"Type":"Submission","SubmissionName":"CWE Content Team","SubmissionOrganization":"MITRE","SubmissionDate":"2008-04-11","SubmissionVersion":"Draft 9","SubmissionReleaseDate":"2008-04-11"},{"Type":"Modification","ModificationName":"Eric Dalci","ModificationOrganization":"Cigital","ModificationDate":"2008-07-01","ModificationComment":"updated Time_of_Introduction"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2008-09-08","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2010-02-16","ModificationComment":"updated Demonstrative_Examples, Description, Name, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2010-09-27","ModificationComment":"updated Observed_Examples, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2011-06-01","ModificationComment":"updated Common_Consequences"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2012-05-11","ModificationComment":"updated Common_Consequences, Demonstrative_Examples, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2013-02-21","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2014-02-18","ModificationComment":"updated Applicable_Platforms"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2014-07-30","ModificationComment":"updated Relationships, Taxonomy_Mappings"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2017-11-08","ModificationComment":"updated Demonstrative_Examples, Taxonomy_Mappings"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2019-01-03","ModificationComment":"updated References, Relationships, Taxonomy_Mappings"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2019-06-20","ModificationComment":"updated Relationships, Type"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2020-02-24","ModificationComment":"updated Applicable_Platforms, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2020-08-20","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2020-12-10","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2021-10-28","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-01-31","ModificationComment":"updated Description"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-04-27","ModificationComment":"updated Relationships, Time_of_Introduction"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-06-29","ModificationComment":"updated Mapping_Notes"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-10-26","ModificationComment":"updated Observed_Examples"},{"Type":"Rename","PreviousEntryName":"Use of a Resource after Expiration or Release","Date":"2010-02-16"}]}