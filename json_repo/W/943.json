{"ID":"943","Name":"Improper Neutralization of Special Elements in Data Query Logic","Abstraction":"Class","Structure":"Simple","Status":"Incomplete","Description":"The product generates a query intended to access or manipulate data in a data store such as a database, but it does not neutralize or incorrectly neutralizes special elements that can modify the intended logic of the query.","ExtendedDescription":"\n\nDepending on the capabilities of the query language, an attacker could inject additional logic into the query to:\n\n\n  - Modify the intended selection criteria, thus changing which data entities (e.g., records) are returned, modified, or otherwise manipulated\n\n  - Append additional commands to the query\n\n  - Return more entities than intended\n\n  - Return fewer entities than intended\n\n  - Cause entities to be sorted in an unexpected way\n\nThe ability to execute additional commands or change which entities are returned has obvious risks. But when the product logic depends on the order or number of entities, this can also lead to vulnerabilities. For example, if the query expects to return only one entity that specifies an administrative user, but an attacker can change which entities are returned, this could cause the logic to return information for a regular user and incorrectly assume that the user has administrative privileges.\n\nWhile this weakness is most commonly associated with SQL injection, there are many other query languages that are also subject to injection attacks, including HTSQL, LDAP, DQL, XQuery, Xpath, and \"NoSQL\" languages.\n","RelatedWeaknesses":[{"Nature":"ChildOf","CweID":"74","ViewID":"1000","Ordinal":"Primary"}],"WeaknessOrdinalities":[{"Ordinality":"Primary"}],"ApplicablePlatforms":[{"Type":"Language","Class":"Not Language-Specific","Prevalence":"Undetermined"}],"AlternateTerms":[{"Term":"NoSQL Injection, NoSQLi","Description":"Injection of data query language into NoSQL databases such as Cassandra, ElasticSearch, MongoDB, Redis, and others"}],"ModesOfIntroduction":[{"Phase":"Implementation","Note":"REALIZATION: This weakness is caused during implementation of an architectural security tactic."}],"CommonConsequences":[{"Scope":["Confidentiality","Integrity","Availability","Access Control"],"Impact":["Bypass Protection Mechanism","Read Application Data","Modify Application Data","Varies by Context"]}],"DetectionMethods":[{"DetectionMethodID":"DM-14","Method":"Automated Static Analysis","Description":"Automated static analysis, commonly referred to as Static Application Security Testing (SAST), can find some instances of this weakness by analyzing source code (or binary/compiled code) without having to execute it. Typically, this is done by building a model of data flow and control flow, then searching for potentially-vulnerable patterns that connect \"sources\" (origins of input) with \"sinks\" (destinations where the data interacts with external components, a lower layer such as the OS, etc.)","Effectiveness":"High"}],"DemonstrativeExamples":[{"ID":"DX-209","Entries":[{"IntroText":"The following code dynamically constructs and executes a SQL query that searches for items matching a specified name. The query restricts the items displayed to those where owner matches the user name of the currently-authenticated user."},{"Nature":"Bad","Language":"C#","ExampleCode":"```\n\t...\n\tstring userName = ctx.getAuthenticatedUserName();\n\tstring query = \"SELECT * FROM items WHERE owner = '\" + userName + \"' AND itemname = '\" + ItemName.Text + \"'\";\n\tsda = new SqlDataAdapter(query, conn);\n\tDataTable dt = new DataTable();\n\tsda.Fill(dt);\n\t...\n```"},{"BodyText":"The query that this code intends to execute follows:"},{"Nature":"Informative","ExampleCode":"```\n\tSELECT * FROM items WHERE owner = \u003cuserName\u003e AND itemname = \u003citemName\u003e;\n```"},{"BodyText":"However, because the query is constructed dynamically by concatenating a constant base query string and a user input string, the query only behaves correctly if itemName does not contain a single-quote character. If an attacker with the user name wiley enters the string:"},{"Nature":"Attack","ExampleCode":"```\n\tname' OR 'a'='a\n```"},{"BodyText":"for itemName, then the query becomes the following:"},{"Nature":"Attack","ExampleCode":"```\n\tSELECT * FROM items WHERE owner = 'wiley' AND itemname = 'name' OR 'a'='a';\n```"},{"BodyText":"The addition of the:"},{"Nature":"Attack","ExampleCode":"```\n\tOR 'a'='a\n```"},{"BodyText":"condition causes the WHERE clause to always evaluate to true, so the query becomes logically equivalent to the much simpler query:"},{"Nature":"Attack","ExampleCode":"```\n\tSELECT * FROM items;\n```"},{"BodyText":"This simplification of the query allows the attacker to bypass the requirement that the query only return items owned by the authenticated user; the query now returns all entries stored in the items table, regardless of their specified owner."}]},{"ID":"DX-210","Entries":[{"IntroText":"The code below constructs an LDAP query using user input address data:"},{"Nature":"Bad","Language":"Java","ExampleCode":"```\n\tcontext = new InitialDirContext(env);\n\tString searchFilter = \"StreetAddress=\" + address;\n\tNamingEnumeration answer = context.search(searchBase, searchFilter, searchCtls);\n```"},{"BodyText":"Because the code fails to neutralize the address string used to construct the query, an attacker can supply an address that includes additional LDAP queries."}]},{"ID":"DX-211","Entries":[{"IntroText":"Consider the following simple XML document that stores authentication information and a snippet of Java code that uses XPath query to retrieve authentication information:"},{"Nature":"Informative","Language":"XML","ExampleCode":"```\n\t\u003cusers\u003e\n\t\t\u003cuser\u003e\n\t\t\t\u003clogin\u003ejohn\u003c/login\u003e\n\t\t\t\u003cpassword\u003eabracadabra\u003c/password\u003e\n\t\t\t\u003chome_dir\u003e/home/john\u003c/home_dir\u003e\n\t\t\u003c/user\u003e\n\t\t\u003cuser\u003e\n\t\t\t\u003clogin\u003ecbc\u003c/login\u003e\n\t\t\t\u003cpassword\u003e1mgr8\u003c/password\u003e\n\t\t\t\u003chome_dir\u003e/home/cbc\u003c/home_dir\u003e\n\t\t\u003c/user\u003e\n\t\u003c/users\u003e\n```"},{"BodyText":"The Java code used to retrieve the home directory based on the provided credentials is:"},{"Nature":"Bad","Language":"Java","ExampleCode":"```\n\tXPath xpath = XPathFactory.newInstance().newXPath();\n\tXPathExpression xlogin = xpath.compile(\"//users/user[login/text()='\" + login.getUserName() + \"' and password/text() = '\" + login.getPassword() + \"']/home_dir/text()\");\n\tDocument d = DocumentBuilderFactory.newInstance().newDocumentBuilder().parse(new File(\"db.xml\"));\n\tString homedir = xlogin.evaluate(d);\n```"},{"BodyText":"Assume that user \"john\" wishes to leverage XPath Injection and login without a valid password. By providing a username \"john\" and password \"' or ''='\" the XPath expression now becomes"},{"Nature":"Attack","ExampleCode":"```\n\t//users/user[login/text()='john' or ''='' and password/text() = '' or ''='']/home_dir/text()\n```"},{"BodyText":"This lets user \"john\" login without a valid password, thus bypassing authentication."}]}],"ObservedExamples":[{"Reference":"CVE-2024-50672","Description":"NoSQL injection in product for building eLearning courses allows password resets using a query processed by the Mongoose find function","Link":"https://www.cve.org/CVERecord?id=CVE-2024-50672"},{"Reference":"CVE-2021-20736","Description":"NoSQL injection in team collaboration product","Link":"https://www.cve.org/CVERecord?id=CVE-2021-20736"},{"Reference":"CVE-2020-35666","Description":"NoSQL injection in a PaaS platform using a MongoDB operator","Link":"https://www.cve.org/CVERecord?id=CVE-2020-35666"},{"Reference":"CVE-2014-2503","Description":"Injection using Documentum Query Language (DQL)","Link":"https://www.cve.org/CVERecord?id=CVE-2014-2503"},{"Reference":"CVE-2014-2508","Description":"Injection using Documentum Query Language (DQL)","Link":"https://www.cve.org/CVERecord?id=CVE-2014-2508"}],"RelatedAttackPatterns":["676"],"References":[{"ExternalReferenceID":"REF-1454","Authors":["PortSwigger"],"Title":"NoSQL injection","URL":"https://portswigger.net/web-security/nosql-injection","URLDate":"2025-02-21"},{"ExternalReferenceID":"REF-1455","Authors":["The SecOps Group"],"Title":"A Pentester's Guide to NoSQL Injection","PublicationYear":"2023","PublicationMonth":"04","PublicationDay":"14","URL":"https://secops.group/a-pentesters-guide-to-nosql-injection/","URLDate":"2025-02-21"}],"MappingNotes":{"Usage":"Allowed-with-Review","Rationale":"This CWE entry is a Class and might have Base-level children that would be more appropriate","Comments":"Examine children of this entry to see if there is a better fit","Reasons":["Abstraction"]},"Notes":[{"Type":"Relationship","Note":"It could be argued that data query languages are effectively a command language - albeit with a limited set of commands - and thus any query-language injection issue could be treated as a child of CWE-74. However, CWE-943 is intended to better organize query-oriented issues to separate them from fully-functioning programming languages, and also to provide a more precise identifier for the many query languages that do not have their own CWE identifier."}],"ContentHistory":[{"Type":"Submission","SubmissionName":"CWE Content Team","SubmissionOrganization":"MITRE","SubmissionDate":"2014-06-19","SubmissionVersion":"2.7","SubmissionReleaseDate":"2014-06-23"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2015-12-07","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2017-11-08","ModificationComment":"updated Modes_of_Introduction, Observed_Examples, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2018-03-27","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2019-06-20","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2020-02-24","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2021-03-15","ModificationComment":"updated Maintenance_Notes"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2022-04-28","ModificationComment":"updated Related_Attack_Patterns"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-01-31","ModificationComment":"updated Description"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-04-27","ModificationComment":"updated Detection_Factors, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-06-29","ModificationComment":"updated Mapping_Notes"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2024-02-29","ModificationComment":"updated Demonstrative_Examples","ModificationVersion":"4.14","ModificationReleaseDate":"2024-02-29"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2025-04-03","ModificationComment":"updated Alternate_Terms, Observed_Examples, References","ModificationVersion":"4.17","ModificationReleaseDate":"2025-04-03"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2025-12-11","ModificationComment":"updated Weakness_Ordinalities","ModificationVersion":"4.19","ModificationReleaseDate":"2025-12-11"}]}