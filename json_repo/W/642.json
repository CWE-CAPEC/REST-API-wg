{"ID":"642","Name":"External Control of Critical State Data","Abstraction":"Class","Structure":"Simple","Status":"Draft","Description":"The product stores security-critical state information about its users, or the product itself, in a location that is accessible to unauthorized actors.","ExtendedDescription":"\n\nIf an attacker can modify the state information without detection, then it could be used to perform unauthorized actions or access unexpected resources, since the application programmer does not expect that the state can be changed.\n\n\nState information can be stored in various locations such as a cookie, in a hidden web form field, input parameter or argument, an environment variable, a database record, within a settings file, etc. All of these locations have the potential to be modified by an attacker. When this state information is used to control security or determine resource usage, then it may create a vulnerability. For example, an application may perform authentication, then save the state in an \"authenticated=true\" cookie. An attacker may simply create this cookie in order to bypass the authentication.\n","LikelihoodOfExploit":"High","RelatedWeaknesses":[{"Nature":"ChildOf","CweID":"668","ViewID":"1000","Ordinal":"Primary"}],"WeaknessOrdinalities":[{"Ordinality":"Primary"},{"Ordinality":"Resultant"}],"ApplicablePlatforms":[{"Type":"Language","Class":"Not Language-Specific","Prevalence":"Undetermined"},{"Type":"Technology","Name":"Web Server","Prevalence":"Often"}],"ModesOfIntroduction":[{"Phase":"Architecture and Design","Note":"OMISSION: This weakness is caused by missing a security tactic during the architecture and design phase."},{"Phase":"Implementation"}],"CommonConsequences":[{"Scope":["Access Control"],"Impact":["Bypass Protection Mechanism","Gain Privileges or Assume Identity"],"Note":"An attacker could potentially modify the state in malicious ways. If the state is related to the privileges or level of authentication that the user has, then state modification might allow the user to bypass authentication or elevate privileges."},{"Scope":["Confidentiality"],"Impact":["Read Application Data"],"Note":"The state variables may contain sensitive information that should not be known by the client."},{"Scope":["Availability"],"Impact":["DoS: Crash, Exit, or Restart"],"Note":"By modifying state variables, the attacker could violate the application's expectations for the contents of the state, leading to a denial of service due to an unexpected error condition."}],"DetectionMethods":[{"DetectionMethodID":"DM-14","Method":"Automated Static Analysis","Description":"Automated static analysis, commonly referred to as Static Application Security Testing (SAST), can find some instances of this weakness by analyzing source code (or binary/compiled code) without having to execute it. Typically, this is done by building a model of data flow and control flow, then searching for potentially-vulnerable patterns that connect \"sources\" (origins of input) with \"sinks\" (destinations where the data interacts with external components, a lower layer such as the OS, etc.)","Effectiveness":"High"},{"Method":"Fuzzing","Description":"Use dynamic tools and techniques that interact with the product using large test suites with many diverse inputs, such as fuzz testing (fuzzing), robustness testing, and fault injection. The product's operation may slow down, but it should not become unstable, crash, or generate incorrect results."}],"PotentialMitigations":[{"Phase":["Architecture and Design"],"Description":"Understand all the potential locations that are accessible to attackers. For example, some programmers assume that cookies and hidden form fields cannot be modified by an attacker, or they may not consider that environment variables can be modified before a privileged program is invoked."},{"MitigationID":"MIT-14","Phase":["Architecture and Design"],"Strategy":"Attack Surface Reduction","Description":"\n\nStore state information and sensitive data on the server side only.\n\n\nEnsure that the system definitively and unambiguously keeps track of its own state and user state and has rules defined for legitimate state transitions. Do not allow any application user to affect state directly in any way other than through legitimate actions leading to state transitions.\n\n\nIf information must be stored on the client, do not do so without encryption and integrity checking, or otherwise having a mechanism on the server side to catch tampering. Use a message authentication code (MAC) algorithm, such as Hash Message Authentication Code (HMAC) [REF-529]. Apply this against the state or sensitive data that has to be exposed, which can guarantee the integrity of the data - i.e., that the data has not been modified. Ensure that a strong hash function is used (CWE-328).\n"},{"Phase":["Architecture and Design"],"Description":"Store state information on the server side only. Ensure that the system definitively and unambiguously keeps track of its own state and user state and has rules defined for legitimate state transitions. Do not allow any application user to affect state directly in any way other than through legitimate actions leading to state transitions."},{"MitigationID":"MIT-4","Phase":["Architecture and Design"],"Strategy":"Libraries or Frameworks","Description":"\n\nUse a vetted library or framework that does not allow this weakness to occur or provides constructs that make this weakness easier to avoid [REF-1482].\n\n\nWith a stateless protocol such as HTTP, use some frameworks can maintain the state for you.\n\n\nExamples include ASP.NET View State and the OWASP ESAPI Session Management feature.\n\n\nBe careful of language features that provide state support, since these might be provided as a convenience to the programmer and may not be considering security.\n"},{"MitigationID":"MIT-15","Phase":["Architecture and Design"],"Description":"For any security checks that are performed on the client side, ensure that these checks are duplicated on the server side, in order to avoid CWE-602. Attackers can bypass the client-side checks by modifying values after the checks have been performed, or by changing the client to remove the client-side checks entirely. Then, these modified values would be submitted to the server."},{"MitigationID":"MIT-16","Phase":["Operation","Implementation"],"Strategy":"Environment Hardening","Description":"When using PHP, configure the application so that it does not use register_globals. During implementation, develop the application so that it does not rely on this feature, but be wary of implementing a register_globals emulation that is subject to weaknesses such as CWE-95, CWE-621, and similar issues."},{"Phase":["Testing"],"Description":"Use tools and techniques that require manual (human) analysis, such as penetration testing, threat modeling, and interactive tools that allow the tester to record and modify an active session. These may be more effective than strictly automated techniques. This is especially the case with weaknesses that are related to design and business rules."}],"DemonstrativeExamples":[{"Entries":[{"IntroText":"In the following example, an authentication flag is read from a browser cookie, thus allowing for external control of user state data."},{"Nature":"Bad","Language":"Java","ExampleCode":"```\n\tCookie[] cookies = request.getCookies();\n\tfor (int i =0; i\u003c cookies.length; i++) {\n\t\tCookie c = cookies[i];\n\t\tif (c.getName().equals(\"authenticated\") \u0026\u0026 Boolean.TRUE.equals(c.getValue())) {\n\t\t\tauthenticated = true;\n\t\t}\n\t}\n```"}]},{"ID":"DX-65","Entries":[{"IntroText":"The following code uses input from an HTTP request to create a file name. The programmer has not considered the possibility that an attacker could provide a file name such as \"../../tomcat/conf/server.xml\", which causes the application to delete one of its own configuration files (CWE-22)."},{"Nature":"Bad","Language":"Java","ExampleCode":"```\n\tString rName = request.getParameter(\"reportName\");\n\tFile rFile = new File(\"/usr/local/apfr/reports/\" + rName);\n\t...\n\trFile.delete();\n```"}]},{"ID":"DX-66","Entries":[{"IntroText":"The following code uses input from a configuration file to determine which file to open and echo back to the user. If the program runs with privileges and malicious users can change the configuration file, they can use the program to read any file on the system that ends with the extension .txt."},{"Nature":"Bad","Language":"Java","ExampleCode":"```\n\tfis = new FileInputStream(cfg.getProperty(\"sub\")+\".txt\");\n\tamt = fis.read(arr);\n\tout.println(arr);\n```"}]},{"ID":"DX-67","Entries":[{"IntroText":"This program is intended to execute a command that lists the contents of a restricted directory, then performs other actions. Assume that it runs with setuid privileges in order to bypass the permissions check by the operating system."},{"Nature":"Bad","Language":"C","ExampleCode":"```\n\t#define DIR \"/restricted/directory\"\n\tchar cmd[500];\n\tsprintf(cmd, \"ls -l %480s\", DIR);\n```\n/* Raise privileges to those needed for accessing DIR. */* \n\t\n\tRaisePrivileges(...);\n\tsystem(cmd);\n\tDropPrivileges(...);\n\t..."},{"BodyText":"This code may look harmless at first, since both the directory and the command are set to fixed values that the attacker can't control. The attacker can only see the contents for DIR, which is the intended program behavior. Finally, the programmer is also careful to limit the code that executes with raised privileges."},{"BodyText":"However, because the program does not modify the PATH environment variable, the following attack would work:"},{"Nature":"Attack","ExampleCode":"- The user sets the PATH to reference a directory under the attacker's control, such as \"/my/dir/\".\n\n  - The attacker creates a malicious program called \"ls\", and puts that program in /my/dir\n\n  - The user executes the program.\n\n  - When system() is executed, the shell consults the PATH to find the ls program\n\n  - The program finds the attacker's malicious program, \"/my/dir/ls\". It doesn't find \"/bin/ls\" because PATH does not contain \"/bin/\".\n\n  - The program executes the attacker's malicious program with the raised privileges."}]},{"Entries":[{"IntroText":"The following code segment implements a basic server that uses the \"ls\" program to perform a directory listing of the directory that is listed in the \"HOMEDIR\" environment variable. The code intends to allow the user to specify an alternate \"LANG\" environment variable. This causes \"ls\" to customize its output based on a given language, which is an important capability when supporting internationalization."},{"Nature":"Bad","Language":"Perl","ExampleCode":"```\n\t$ENV{\"HOMEDIR\"} = \"/home/mydir/public/\";\n\tmy $stream = AcceptUntrustedInputStream();\n\twhile (\u003c$stream\u003e) {\n\t\t\tchomp;\n\t\t\tif (/^ENV ([\\w\\_]+) (.*)/) {\n\t\t\t\t$ENV{$1} = $2;\n\t\t\t}\n\t\t\telsif (/^QUIT/) { ... }\n\t\t\telsif (/^LIST/) {\n\t\t\t\topen($fh, \"/bin/ls -l $ENV{HOMEDIR}|\");\n\t\t\t\twhile (\u003c$fh\u003e) {\n\t\t\t\t\tSendOutput($stream, \"FILEINFO: $_\");\n\t\t\t\t}\n\t\t\t\tclose($fh);\n\t\t\t}\n\t}\n```"},{"BodyText":"The programmer takes care to call a specific \"ls\" program and sets the HOMEDIR to a fixed value. However, an attacker can use a command such as \"ENV HOMEDIR /secret/directory\" to specify an alternate directory, enabling a path traversal attack (CWE-22). At the same time, other attacks are enabled as well, such as OS command injection (CWE-78) by setting HOMEDIR to a value such as \"/tmp; rm -rf /\". In this case, the programmer never intends for HOMEDIR to be modified, so input validation for HOMEDIR is not the solution. A partial solution would be an allowlist that only allows the LANG variable to be specified in the ENV command. Alternately, assuming this is an authenticated user, the language could be stored in a local file so that no ENV command at all would be needed."},{"BodyText":"While this example may not appear realistic, this type of problem shows up in code fairly frequently. See CVE-1999-0073 in the observed examples for a real-world example with similar behaviors."}]}],"ObservedExamples":[{"Reference":"CVE-2005-2428","Description":"Mail client stores password hashes for unrelated accounts in a hidden form field.","Link":"https://www.cve.org/CVERecord?id=CVE-2005-2428"},{"Reference":"CVE-2008-0306","Description":"Privileged program trusts user-specified environment variable to modify critical configuration settings.","Link":"https://www.cve.org/CVERecord?id=CVE-2008-0306"},{"Reference":"CVE-1999-0073","Description":"Telnet daemon allows remote clients to specify critical environment variables for the server, leading to code execution.","Link":"https://www.cve.org/CVERecord?id=CVE-1999-0073"},{"Reference":"CVE-2007-4432","Description":"Untrusted search path vulnerability through modified LD_LIBRARY_PATH environment variable.","Link":"https://www.cve.org/CVERecord?id=CVE-2007-4432"},{"Reference":"CVE-2006-7191","Description":"Untrusted search path vulnerability through modified LD_LIBRARY_PATH environment variable.","Link":"https://www.cve.org/CVERecord?id=CVE-2006-7191"},{"Reference":"CVE-2008-5738","Description":"Calendar application allows bypass of authentication by setting a certain cookie value to 1.","Link":"https://www.cve.org/CVERecord?id=CVE-2008-5738"},{"Reference":"CVE-2008-5642","Description":"Setting of a language preference in a cookie enables path traversal attack.","Link":"https://www.cve.org/CVERecord?id=CVE-2008-5642"},{"Reference":"CVE-2008-5125","Description":"Application allows admin privileges by setting a cookie value to \"admin.\"","Link":"https://www.cve.org/CVERecord?id=CVE-2008-5125"},{"Reference":"CVE-2008-5065","Description":"Application allows admin privileges by setting a cookie value to \"admin.\"","Link":"https://www.cve.org/CVERecord?id=CVE-2008-5065"},{"Reference":"CVE-2008-4752","Description":"Application allows admin privileges by setting a cookie value to \"admin.\"","Link":"https://www.cve.org/CVERecord?id=CVE-2008-4752"},{"Reference":"CVE-2000-0102","Description":"Shopping cart allows price modification via hidden form field.","Link":"https://www.cve.org/CVERecord?id=CVE-2000-0102"},{"Reference":"CVE-2000-0253","Description":"Shopping cart allows price modification via hidden form field.","Link":"https://www.cve.org/CVERecord?id=CVE-2000-0253"},{"Reference":"CVE-2008-1319","Description":"Server allows client to specify the search path, which can be modified to point to a program that the client has uploaded.","Link":"https://www.cve.org/CVERecord?id=CVE-2008-1319"}],"TaxonomyMappings":[{"TaxonomyName":"Software Fault Patterns","EntryID":"SFP23","EntryName":"Exposed Data"}],"RelatedAttackPatterns":["21","31"],"References":[{"ExternalReferenceID":"REF-528","Authors":["OWASP"],"Title":"Top 10 2007-Insecure Direct Object Reference","PublicationYear":"2007","URL":"https://web.archive.org/web/20160319225940/http://www.owasp.org/index.php/Top_10_2007-A4","URLDate":"2025-08-04"},{"ExternalReferenceID":"REF-529","Title":"HMAC","PublicationYear":"2011","PublicationMonth":"08","PublicationDay":"18","Publisher":"Wikipedia","URL":"https://en.wikipedia.org/wiki/HMAC","URLDate":"2023-04-07"},{"ExternalReferenceID":"REF-44","Section":"\"Sin 4: Use of Magic URLs, Predictable Cookies, and Hidden Form\n                  Fields.\" Page 75","Authors":["Michael Howard","David LeBlanc","John Viega"],"Title":"24 Deadly Sins of Software Security","Publication":"McGraw-Hill","PublicationYear":"2010"},{"ExternalReferenceID":"REF-1482","Authors":["D3FEND"],"Title":"D3FEND: D3-TL Trusted Library","URL":"https://d3fend.mitre.org/technique/d3f:TrustedLibrary/","URLDate":"2025-09-06"}],"MappingNotes":{"Usage":"Allowed-with-Review","Rationale":"This CWE entry is a Class and might have Base-level children that would be more appropriate","Comments":"Examine children of this entry to see if there is a better fit","Reasons":["Abstraction"]},"ContentHistory":[{"Type":"Submission","SubmissionName":"Evgeny Lebanidze","SubmissionOrganization":"Cigital","SubmissionDate":"2008-01-30","SubmissionVersion":"Draft 8","SubmissionReleaseDate":"2008-01-30"},{"Type":"Modification","ModificationName":"Sean Eidemiller","ModificationOrganization":"Cigital","ModificationDate":"2008-07-01","ModificationComment":"added/updated demonstrative examples"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2008-09-08","ModificationComment":"updated Common_Consequences, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2008-10-14","ModificationComment":"updated Description"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2009-01-12","ModificationComment":"updated Applicable_Platforms, Common_Consequences, Demonstrative_Examples, Description, Name, Observed_Examples, Potential_Mitigations, References, Relationships, Relevant_Properties, Type"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2009-03-10","ModificationComment":"updated Potential_Mitigations"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2009-07-27","ModificationComment":"updated Related_Attack_Patterns"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2010-02-16","ModificationComment":"updated Potential_Mitigations"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2010-06-21","ModificationComment":"updated Potential_Mitigations"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2011-06-01","ModificationComment":"updated Common_Consequences"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2012-05-11","ModificationComment":"updated Demonstrative_Examples, Potential_Mitigations, References, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2012-10-30","ModificationComment":"updated Potential_Mitigations"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2014-02-18","ModificationComment":"updated Potential_Mitigations"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2014-07-30","ModificationComment":"updated Relationships, Taxonomy_Mappings"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2017-01-19","ModificationComment":"updated Related_Attack_Patterns, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2017-11-08","ModificationComment":"updated Applicable_Platforms, Demonstrative_Examples, Enabling_Factors_for_Exploitation, Modes_of_Introduction, References, Relationships, Relevant_Properties"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2020-02-24","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2020-06-25","ModificationComment":"updated Demonstrative_Examples"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2021-03-15","ModificationComment":"updated Demonstrative_Examples"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2021-10-28","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-01-31","ModificationComment":"updated Description, Potential_Mitigations"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-04-27","ModificationComment":"updated Detection_Factors, Potential_Mitigations, References, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-06-29","ModificationComment":"updated Mapping_Notes"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2025-09-09","ModificationComment":"updated Potential_Mitigations, References","ModificationVersion":"4.18","ModificationReleaseDate":"2025-09-09"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2025-12-11","ModificationComment":"updated Detection_Factors, Potential_Mitigations, Relationships, Weakness_Ordinalities","ModificationVersion":"4.19","ModificationReleaseDate":"2025-12-11"},{"Type":"Rename","PreviousEntryName":"Insufficient Management of User State","Date":"2008-04-11"},{"Type":"Rename","PreviousEntryName":"External Control of User State Data","Date":"2009-01-12"}]}