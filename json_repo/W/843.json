{"ID":"843","Name":"Access of Resource Using Incompatible Type ('Type Confusion')","Abstraction":"Base","Structure":"Simple","Status":"Incomplete","Description":"The product allocates or initializes a resource such as a pointer, object, or variable using one type, but it later accesses that resource using a type that is incompatible with the original type.","ExtendedDescription":"\n\nWhen the product accesses the resource using an incompatible type, this could trigger logical errors because the resource does not have expected properties. In languages without memory safety, such as C and C++, type confusion can lead to out-of-bounds memory access.\n\n\nWhile this weakness is frequently associated with unions when parsing data with many different embedded object types in C, it can be present in any application that can interpret the same variable or memory location in multiple ways.\n\n\nThis weakness is not unique to C and C++. For example, errors in PHP applications can be triggered by providing array parameters when scalars are expected, or vice versa. Languages such as Perl, which perform automatic conversion of a variable of one type when it is accessed as if it were another type, can also contain these issues.\n","RelatedWeaknesses":[{"Nature":"ChildOf","CweID":"704","ViewID":"1000","Ordinal":"Primary"},{"Nature":"ChildOf","CweID":"704","ViewID":"1003","Ordinal":"Primary"},{"Nature":"CanPrecede","CweID":"119","ViewID":"1000"}],"ApplicablePlatforms":[{"Type":"Language","Name":"C","Prevalence":"Undetermined"},{"Type":"Language","Name":"C++","Prevalence":"Undetermined"}],"AlternateTerms":[{"Term":"Object Type Confusion"}],"ModesOfIntroduction":[{"Phase":"Implementation"}],"CommonConsequences":[{"Scope":["Availability","Integrity","Confidentiality"],"Impact":["Read Memory","Modify Memory","Execute Unauthorized Code or Commands","DoS: Crash, Exit, or Restart"],"Note":"When a memory buffer is accessed using the wrong type, it could read or write memory out of the bounds of the buffer, if the allocated buffer is smaller than the type that the code is attempting to access, leading to a crash and possibly code execution."}],"DemonstrativeExamples":[{"ID":"DX-188","Entries":[{"IntroText":"The following code uses a union to support the representation of different types of messages. It formats messages differently, depending on their type."},{"Nature":"Bad","Language":"C","ExampleCode":"```\n\t#define NAME_TYPE 1\n\t#define ID_TYPE 2\n\tstruct MessageBuffer\n\t{\n\t\tint msgType;\n\t\tunion {\n\t\t\tchar *name;\n\t\t\tint nameID;\n\t\t};\n\t};\n\tint main (int argc, char **argv) {\n\t\t\tstruct MessageBuffer buf;\n\t\t\tchar *defaultMessage = \"Hello World\";\n\t\t\tbuf.msgType = NAME_TYPE;\n\t\t\tbuf.name = defaultMessage;\n\t\t\tprintf(\"Pointer of buf.name is %p\\n\", buf.name);\n```\n/* This particular value for nameID is used to make the code architecture-independent. If coming from untrusted input, it could be any value. */* \n\t\t\t\n\t\t\tbuf.nameID = (int)(defaultMessage + 1);\n\t\t\tprintf(\"Pointer of buf.name is now %p\\n\", buf.name);\n\t\t\tif (buf.msgType == NAME_TYPE) {\n\t\t\t```\n\t\t\t\tprintf(\"Message: %s\\n\", buf.name);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprintf(\"Message: Use ID %d\\n\", buf.nameID);\n\t\t\t}\n\t}\n```"},{"BodyText":"The code intends to process the message as a NAME_TYPE, and sets the default message to \"Hello World.\" However, since both buf.name and buf.nameID are part of the same union, they can act as aliases for the same memory location, depending on memory layout after compilation."},{"BodyText":"As a result, modification of buf.nameID - an int - can effectively modify the pointer that is stored in buf.name - a string."},{"BodyText":"Execution of the program might generate output such as:"},{"BodyText":"```\n\t\tPointer of name is 10830\n\t\tPointer of name is now 10831\n\t\tMessage: ello World\n```"},{"BodyText":"Notice how the pointer for buf.name was changed, even though buf.name was not explicitly modified."},{"BodyText":"In this case, the first \"H\" character of the message is omitted. However, if an attacker is able to fully control the value of buf.nameID, then buf.name could contain an arbitrary pointer, leading to out-of-bounds reads or writes."}]},{"Entries":[{"IntroText":"The following PHP code accepts a value, adds 5, and prints the sum."},{"Nature":"Bad","Language":"PHP","ExampleCode":"```\n\t$value = $_GET['value'];\n\t$sum = $value + 5;\n\techo \"value parameter is '$value'\u003cp\u003e\";\n\techo \"SUM is $sum\";\n```"},{"BodyText":"When called with the following query string:"},{"BodyText":"```\n\t\tvalue=123\n```"},{"BodyText":"the program calculates the sum and prints out:"},{"BodyText":"```\n\t\tSUM is 128\n```"},{"BodyText":"However, the attacker could supply a query string such as:"},{"BodyText":"```\n\t\tvalue[]=123\n```"},{"BodyText":"The \"[]\" array syntax causes $value to be treated as an array type, which then generates a fatal error when calculating $sum:"},{"BodyText":"```\n\t\tFatal error: Unsupported operand types in program.php on line 2\n```"}]},{"Entries":[{"IntroText":"The following Perl code is intended to look up the privileges for user ID's between 0 and 3, by performing an access of the $UserPrivilegeArray reference. It is expected that only userID 3 is an admin (since this is listed in the third element of the array)."},{"Nature":"Bad","Language":"Perl","ExampleCode":"```\n\tmy $UserPrivilegeArray = [\"user\", \"user\", \"admin\", \"user\"];\n\tmy $userID = get_current_user_ID();\n\tif ($UserPrivilegeArray eq \"user\") {\n\t\tprint \"Regular user!\\n\";\n\t}\n\telse {\n\t\tprint \"Admin!\\n\";\n\t}\n\tprint \"\\$UserPrivilegeArray = $UserPrivilegeArray\\n\";\n```"},{"BodyText":"In this case, the programmer intended to use \"$UserPrivilegeArray-\u003e{$userID}\" to access the proper position in the array. But because the subscript was omitted, the \"user\" string was compared to the scalar representation of the $UserPrivilegeArray reference, which might be of the form \"ARRAY(0x229e8)\" or similar."},{"BodyText":"Since the logic also \"fails open\" (CWE-636), the result of this bug is that all users are assigned administrator privileges."},{"BodyText":"While this is a forced example, it demonstrates how type confusion can have security consequences, even in memory-safe languages."}]}],"ObservedExamples":[{"Reference":"CVE-2010-4577","Description":"Type confusion in CSS sequence leads to out-of-bounds read.","Link":"https://www.cve.org/CVERecord?id=CVE-2010-4577"},{"Reference":"CVE-2011-0611","Description":"Size inconsistency allows code execution, first discovered when it was actively exploited in-the-wild.","Link":"https://www.cve.org/CVERecord?id=CVE-2011-0611"},{"Reference":"CVE-2010-0258","Description":"Improperly-parsed file containing records of different types leads to code execution when a memory location is interpreted as a different object than intended.","Link":"https://www.cve.org/CVERecord?id=CVE-2010-0258"}],"TaxonomyMappings":[{"TaxonomyName":"CERT C Secure Coding","EntryID":"EXP39-C","EntryName":"Do not access a variable through a pointer of an incompatible type","MappingFit":"Exact"}],"References":[{"ExternalReferenceID":"REF-811","Section":"\"Type Confusion Vulnerabilities,\" page 59","Authors":["Mark Dowd","Ryan Smith","David Dewey"],"Title":"Attacking Interoperability","PublicationYear":"2009","URL":"http://hustlelabs.com/stuff/bh2009_dowd_smith_dewey.pdf","URLDate":"2023-04-07"},{"ExternalReferenceID":"REF-62","Section":"Chapter 7, \"Type Confusion\", Page 319","Authors":["Mark Dowd","John McDonald","Justin Schuh"],"Title":"The Art of Software Security Assessment","Edition":"1st Edition","PublicationYear":"2006","Publisher":"Addison Wesley"}],"MappingNotes":{"Usage":"Allowed","Rationale":"This CWE entry is at the Base level of abstraction, which is a preferred level of abstraction for mapping to the root causes of vulnerabilities.","Comments":"Carefully read both the name and description to ensure that this mapping is an appropriate fit. Do not try to 'force' a mapping to a lower-level Base/Variant simply to comply with this preferred level of abstraction.","Reasons":["Acceptable-Use"]},"Notes":[{"Type":"Applicable Platform","Note":"\n\nThis weakness is possible in any type-unsafe programming language.\n"},{"Type":"Research Gap","Note":"\n\nType confusion weaknesses have received some attention by applied researchers and major software vendors for C and C++ code. Some publicly-reported vulnerabilities probably have type confusion as a root-cause weakness, but these may be described as \"memory corruption\" instead.\n\n\nFor other languages, there are very few public reports of type confusion weaknesses. These are probably under-studied. Since many programs rely directly or indirectly on loose typing, a potential \"type confusion\" behavior might be intentional, possibly requiring more manual analysis.\n"}],"ContentHistory":[{"Type":"Submission","SubmissionName":"CWE Content Team","SubmissionOrganization":"MITRE","SubmissionDate":"2011-05-15","SubmissionVersion":"1.13","SubmissionReleaseDate":"2011-06-01"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2012-05-11","ModificationComment":"updated References"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2017-11-08","ModificationComment":"updated Applicable_Platforms, Taxonomy_Mappings"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2019-01-03","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2019-06-20","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2020-02-24","ModificationComment":"updated Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2020-06-25","ModificationComment":"updated Common_Consequences, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2022-04-28","ModificationComment":"updated Research_Gaps"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-01-31","ModificationComment":"updated Description"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-04-27","ModificationComment":"updated References, Relationships"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-06-29","ModificationComment":"updated Mapping_Notes"},{"Type":"Modification","ModificationName":"CWE Content Team","ModificationOrganization":"MITRE","ModificationDate":"2023-10-26","ModificationComment":"updated Demonstrative_Examples"}]}